use game_sdk::gamerules::{get_result, is_game_finished};
use game_sdk::{Action, ClientListener, Color, GameState};
use player::search::Searcher;
use player::timecontrol::Timecontrol;
use std::time::Instant;

fn main() {
    // Do some perft testing
    //FEN of midgame position:
    //FEN: 20 RED 19807040637789456435240771584 576460752303423488 0 0 0 140737488355328 0 0 0 34359738368 4835703278458585418301440 140737488355328 2417851639229258349412352 8388608 2361183241434822606848 144115188109410304 0 288230376151711744 576460752303423488
    //generate_magic();
    //panic!("stop");
    let states= vec![
        "52 RED 321864410214198871482362232832 134217728 0 0 0 65536 0 0 0 2251799813685248 38685626227669233102225440 65536 49152 274945019904 134217728 2199023263745 1125899906842624 79228162518876023611971338240 18898689303515435630592",
        "54 RED 321864410214198871482362232832 134217728 0 0 0 0 134217728 0 0 2251799813685248 38685626227669233370660864 65536 49152 274945019904 134217728 2199023263745 1125899906842624 79228162518876023611971338240 18898689303515435630592",
        "56 RED 321864410214198871482362232832 134217728 0 134217728 0 2251799813685248 134217728 0 0 2251799813685248 38685626227669233370660864 0 49152 274945019904 134217728 2199023263745 0 79228162518876023611971338240 18898689303515435630592",
        "58 RED 321864410214198871482362232832 134250496 0 0 0 0 134217728 0 0 2251799813685248 38685626227669233370660864 0 49152 274945019904 134217728 2199023263745 1125899906842624 79228162518876023611971338240 18898689303515435630592"
    ];
    let mut searcher = Searcher::with_tc(Timecontrol::MoveTime(1000));
    for state in states {
        let state = GameState::from_fen(state.to_owned());
        searcher.on_move_request(&state);
    }
    panic!("Stop debug");
    let state = GameState::from_fen("20 RED 19807040637789456435240771584 576460752303423488 0 0 0 140737488355328 0 0 0 34359738368 4835703278458585418301440 140737488355328 2417851639229258349412352 8388608 2361183241434822606848 144115188109410304 0 288230376151711744 576460752303423488".to_owned());
    let now = Instant::now();
    let nodes = state.perft(5);
    let time_elapsed = now.elapsed().as_micros();
    let nps = (1000 * nodes) as f64 / time_elapsed as f64;
    println!(
        "Time: {}ms, Nodes: {}, KNPS: {}",
        time_elapsed as f64 / 1000.,
        nodes,
        nps
    );
    for i in 1..=5 {
        println!("{}: {}", i, state.perft(i));
    }
    let mut searcher = Searcher::with_tc(Timecontrol::Infinite);
    let state = GameState::from_fen("37 BLUE 288230651063173120 0 72057594037927936 0 0 72057594037927936 0 0 0 72057594037927936 35184376285184 1 140754668224512 103087603712 65536 8204 2 16 147573952589676412928".to_owned());
    searcher.search_move(&state);
}
